<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Search</title>
    <link rel="stylesheet" href="formatstyle.css">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use Inter font for a clean, modern look */
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        /* Custom classes for sentiment coloring */
        /* Tailwind colors used: Green 100/200/500, Red 100/200/500, Gray */
        .bullish { color: #065F46; border-color: #A7F3D0; background-color: #D1FAE5; } 
        .bearish { color: #991B1B; border-color: #FEE2E2; background-color: #FEECEE; }
        .neutral, .error { color: #4B5563; border-color: #E5E7EB; background-color: #F3F4F6; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">


     <div class="topnav">
        <a class="active" href="/capstone/stock_calculation/format.html">Home</a>
        <a href="https://www.investors.com/market-trend/stock-market-today/stock-market-today/">News</a>
        <a href="/notes.html">notes</a>
        <a href="/about.html">about</a>
        <a href="/index.html">logout</a>
      </div>



    <!-- Header and Search Form -->
    <div class="w-full max-w-xl bg-white p-6 rounded-xl shadow-2xl mt-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Financial Data Search & Sentiment</h1>
        
        <form id="search-form" class="flex gap-2">
            <input 
                type="text" 
                id="stock-symbol" 
                placeholder="Enter stock symbol (e.g., IBM)" 
                required 
                class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg uppercase"
                maxlength="5"
            >
            <button 
                type="submit" 
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200"
            >
                Search
            </button>
        </form>
    </div>

    <!-- Status Message Area -->
    <div id="status-message" class="mt-6 text-lg font-medium text-gray-700">
        Ready to search.
    </div>

    <!-- Results Display Area -->
    <div id="results-container" class="w-full max-w-3xl mt-8 p-6 bg-white rounded-xl shadow-lg hidden">
        
        <!-- SENTIMENT RESULT CARD -->
        <div id="sentiment-card" class="p-4 mb-6 rounded-xl border-2 text-center font-bold text-lg">
            Awaiting Prediction...
        </div>

        <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Latest Price Data</h2>
        <div id="meta-data"></div>
        <div id="price-data" class="space-y-4"></div>
        <p id="no-data-msg" class="hidden text-gray-500 italic">No price data available for this symbol.</p>
    </div>

    <script>
        const searchForm = document.getElementById('search-form');
        const stockSymbolInput = document.getElementById('stock-symbol');
        const statusMessage = document.getElementById('status-message');
        const resultsContainer = document.getElementById('results-container');
        const sentimentCard = document.getElementById('sentiment-card');
        const metaDataContainer = document.getElementById('meta-data');
        const priceDataContainer = document.getElementById('price-data');
        const noDataMsg = document.getElementById('no-data-msg');

        // Function to display messages (loading, error, success)
        const displayStatus = (message, type = 'info') => {
            statusMessage.textContent = message;
            statusMessage.className = 'mt-6 text-lg font-medium';
            if (type === 'error') {
                statusMessage.classList.add('text-red-600');
            } else if (type === 'success') {
                statusMessage.classList.add('text-green-600');
            } else {
                statusMessage.classList.add('text-gray-700');
            }
        };

        // Helper to get the correct CSS class for the sentiment
        const getSentimentClass = (prediction) => {
            if (prediction === 'Bullish') return 'bullish';
            if (prediction === 'Bearish') return 'bearish';
            return 'neutral';
        };

        // Function to render the fetched data
        const renderData = (data) => {
            // SHOW the results container
            resultsContainer.classList.remove('hidden');

            // Clear previous results
            metaDataContainer.innerHTML = '';
            priceDataContainer.innerHTML = '';
            noDataMsg.classList.add('hidden');

            const meta = data.meta;
            const rows = data.rows;
            // Get the sentiment object from the response (defaulting if not present)
            const sentiment = data.sentiment || { prediction: "Error", message: "No sentiment data." };
            
            // --- 1. Display Sentiment Card ---
            const sentimentClass = getSentimentClass(sentiment.prediction);
            let scoreDisplay = sentiment.score !== undefined && sentiment.score !== null ? ` (Trend Score: ${sentiment.score})` : '';

            sentimentCard.className = `p-4 mb-6 rounded-xl border-2 text-center font-bold text-lg ${sentimentClass}`;
            sentimentCard.innerHTML = `
                <span class="text-2xl">${sentiment.prediction}</span>
                <p class="font-normal text-sm mt-1">${sentiment.message}${scoreDisplay}</p>
            `;


            if (!rows || rows.length === 0) {
                noDataMsg.classList.remove('hidden');
                displayStatus(`Data fetched for ${meta.symbol}, but no price bars were found.`, 'info');
                return;
            }

            displayStatus(`Data and Sentiment successfully loaded for ${meta.symbol}.`, 'success');
            
            // --- 2. Display Meta Data (Summary) ---
            metaDataContainer.innerHTML = `
                <div class="p-3 mb-4 bg-indigo-50 rounded-lg border border-indigo-200">
                    <p><strong>Symbol:</strong> <span class="uppercase">${meta.symbol}</span></p>
                    <p><strong>Last Refreshed:</strong> ${meta.last_refreshed || 'N/A'}</p>
                    <p><strong>Time Zone:</strong> ${meta.time_zone || 'N/A'}</p>
                    ${meta.interval ? `<p><strong>Interval:</strong> ${meta.interval}</p>` : ''}
                </div>
            `;


            // --- 3. Display Price Data (Last 10 rows) ---
            const latestRows = rows.slice(-10); // Get the 10 newest rows
            
            // Create table structure for better display
            let tableHtml = `
                <h3 class="text-lg font-semibold mt-6 mb-3 text-gray-800">Latest 10 Price Bars (${meta.interval || 'Daily'})</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 shadow-md rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Open</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Close</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">High / Low</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Volume</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;

            latestRows.forEach(row => {
                const ts = row.timestamp; 
                // Determine color based on whether the closing price increased (Bullish) or decreased (Bearish) relative to open
                const priceChangeClass = row.close >= row.open ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold';

                tableHtml += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${ts.split('T')[0]}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row.open.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${priceChangeClass}">${row.close.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row.high.toFixed(2)} / ${row.low.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row.volume.toLocaleString()}</td>
                    </tr>
                `;
            });

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            priceDataContainer.innerHTML = tableHtml;
        };

        // Main function to fetch data from the backend API
        const fetchStockData = async (symbol) => {
            const url = `/api/stock?symbol=${symbol.toUpperCase()}`;
            displayStatus(`Fetching data and calculating sentiment for ${symbol.toUpperCase()}...`, 'info');

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok) {
                    resultsContainer.classList.add('hidden');
                    displayStatus(`Error: ${data.error || 'Unknown server error.'}`, 'error');
                    metaDataContainer.innerHTML = '';
                    priceDataContainer.innerHTML = '';
                    return;
                }

                // Successful result (includes data and sentiment)
                renderData(data);

            } catch (error) {
                console.error('Fetch failed:', error);
                resultsContainer.classList.add('hidden');
                displayStatus('A network error occurred. Check server connection.', 'error');
            }
        };

        // Event listener for form submission
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const symbol = stockSymbolInput.value.trim();
            if (symbol) {
                fetchStockData(symbol);
            }
        });

    </script>
</body>
</html>
